<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude代理服务器 - 管理后台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; color: #333; }
        .logout { float: right; }
        .logout form { display: inline; }
        .logout button { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .stat-label { color: #666; margin-top: 5px; }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .create-form { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 20px; }
        .create-form input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .create-form button { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; }
        .status-active { color: #28a745; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }
        .btn-small { padding: 4px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-danger { background: #dc3545; color: white; }
        .api-key { font-family: monospace; background: #f8f9fa; padding: 4px 8px; border-radius: 4px; word-break: break-all; }
        .new-key-alert { background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #28a745; }
        
        /* 标签页样式 */
        .tabs { display: flex; background: white; border-radius: 8px 8px 0 0; overflow: hidden; margin-bottom: 0; }
        .tab { padding: 15px 25px; cursor: pointer; background: #f8f9fa; border-right: 1px solid #ddd; }
        .tab.active { background: white; color: #007bff; font-weight: bold; }
        .tab:hover { background: #e9ecef; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* 图表容器 */
        .chart-container { background: white; padding: 20px; border-radius: 0 0 8px 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .chart-section { background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .chart-section h3 { margin-top: 0; color: #333; }
        .chart-wrapper { position: relative; height: 300px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Claude代理服务器 - 管理后台</h1>
        <div class="logout">
            <form method="post" action="/web/logout">
                <button type="submit">退出登录</button>
            </form>
        </div>
    </div>

    {% if request.query_params.get('new_key') %}
    <div class="new-key-alert">
        <strong>新API密钥已创建:</strong><br>
        <div class="api-key">{{ request.query_params.get('new_key') }}</div>
        <small>请立即复制保存，此密钥不会再次显示</small>
    </div>
    {% endif %}

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_api_keys }}</div>
            <div class="stat-label">API密钥总数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_requests }}</div>
            <div class="stat-label">总请求数</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ "{:,.0f}".format(stats.total_tokens) }}</div>
            <div class="stat-label">总Token使用量</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${{ "{:.2f}".format(stats.total_cost) }}</div>
            <div class="stat-label">总成本</div>
        </div>
    </div>

    <!-- 标签页导航 -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('overview')">总览</div>
        <div class="tab" onclick="switchTab('backends')">后端管理</div>
        <div class="tab" onclick="switchTab('charts')">使用趋势图</div>
    </div>

    <!-- 总览标签页 -->
    <div id="overview" class="tab-content active chart-container">
        <div class="section">
            <h2>创建新API密钥</h2>
            <form method="post" action="/web/create-key" class="create-form">
                <div>
                    <label>名称:</label>
                    <input type="text" name="name" required placeholder="客户端名称">
                </div>
                <div>
                    <label>速率限制 (请求/小时):</label>
                    <input type="number" name="rate_limit" value="1000" required>
                </div>
                <div>
                    <label>配额限制 (Token):</label>
                    <input type="number" name="quota_limit" value="100000" required>
                </div>
                <button type="submit">创建密钥</button>
            </form>
        </div>

        <div class="section">
            <h2>API密钥管理</h2>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>状态</th>
                        <th>速率限制</th>
                        <th>配额限制</th>
                        <th>总请求数</th>
                        <th>总Token使用量</th>
                        <th>总成本</th>
                        <th>今日请求</th>
                        <th>今日Token</th>
                        <th>创建时间</th>
                        <th>最后使用</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in api_keys_with_stats %}
                    {% set key = item.key %}
                    {% set stats = item.stats %}
                    <tr id="row-{{ key.id }}">
                        <td><strong>{{ key.name }}</strong></td>
                        <td>
                            {% if key.is_active %}
                                <span class="status-active">活跃</span>
                            {% else %}
                                <span class="status-inactive">已停用</span>
                            {% endif %}
                        </td>
                        <td>
                            <span id="rate-display-{{ key.id }}">{{ key.rate_limit }}/小时</span>
                            <input type="number" id="rate-edit-{{ key.id }}" value="{{ key.rate_limit }}" style="display: none; width: 80px;">
                        </td>
                        <td>
                            <span id="quota-display-{{ key.id }}">{{ "{:,}".format(key.quota_limit) }}</span>
                            <input type="number" id="quota-edit-{{ key.id }}" value="{{ key.quota_limit }}" style="display: none; width: 100px;">
                        </td>
                        <td>{{ "{:,}".format(stats.total_requests) }}</td>
                        <td>{{ "{:,}".format(stats.total_tokens) }}</td>
                        <td>${{ "{:.4f}".format(stats.total_cost) }}</td>
                        <td>{{ "{:,}".format(stats.requests_today) }}</td>
                        <td>{{ "{:,}".format(stats.tokens_today) }}</td>
                        <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if key.last_used %}
                                {{ key.last_used.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                <span style="color: #888;">未使用</span>
                            {% endif %}
                        </td>
                        <td>
                            <div id="actions-display-{{ key.id }}">
                                {% if key.is_active %}
                                    <form method="post" action="/web/deactivate-key/{{ key.id }}" style="display: inline;">
                                        <button type="submit" class="btn-small btn-danger" 
                                                onclick="return confirm('确定要停用这个API密钥吗？')">停用</button>
                                    </form>
                                {% endif %}
                                <button class="btn-small" style="background: #007bff; color: white; margin-left: 5px;" 
                                        onclick="showKeyDetails('{{ key.id }}', '{{ key.name }}')">详情</button>
                                <button class="btn-small" style="background: #17a2b8; color: white; margin-left: 5px;" 
                                        onclick="editKey('{{ key.id }}')">编辑</button>
                            </div>
                            <div id="actions-edit-{{ key.id }}" style="display: none;">
                                <button class="btn-small" style="background: #28a745; color: white;" 
                                        onclick="saveKey('{{ key.id }}')">保存</button>
                                <button class="btn-small" style="background: #6c757d; color: white; margin-left: 5px;" 
                                        onclick="cancelEdit('{{ key.id }}')">取消</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not api_keys_with_stats %}
            <p style="text-align: center; color: #666; padding: 20px;">暂无API密钥</p>
            {% endif %}
        </div>
    </div>

    <!-- 后端管理标签页 -->
    <div id="backends" class="tab-content chart-container">
        <div class="section">
            <h2>当前激活后端</h2>
            {% if active_config %}
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <strong>{{ active_config.name }}</strong><br>
                <small>Base URL: {{ active_config.base_url }}</small><br>
                <small>创建时间: {{ active_config.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            </div>
            {% else %}
            <div style="background: #f8d7da; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                <strong>警告:</strong> 没有激活的后端配置！
            </div>
            {% endif %}
        </div>

        <div class="section">
            <h2>添加新后端</h2>
            <form method="post" action="/web/create-backend" style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 15px; align-items: end; margin-bottom: 20px;">
                <div>
                    <label>名称:</label>
                    <input type="text" name="name" required placeholder="后端名称">
                </div>
                <div>
                    <label>Base URL:</label>
                    <input type="url" name="base_url" required placeholder="https://api.example.com">
                </div>
                <div>
                    <label>API Key:</label>
                    <input type="password" name="api_key" required placeholder="sk-...">
                </div>
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <label style="margin-bottom: 5px;">
                        <input type="checkbox" name="is_default"> 设为默认
                    </label>
                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">添加后端</button>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>后端配置列表</h2>
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>Base URL</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for config in backend_configs %}
                    <tr style="{% if config.is_active %}background-color: #d4edda;{% endif %}">
                        <td>
                            <strong>{{ config.name }}</strong>
                            {% if config.is_default %}
                                <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">默认</span>
                            {% endif %}
                        </td>
                        <td><code>{{ config.base_url }}</code></td>
                        <td>
                            {% if config.is_active %}
                                <span style="color: #28a745; font-weight: bold;">● 激活中</span>
                            {% else %}
                                <span style="color: #6c757d;">○ 未激活</span>
                            {% endif %}
                        </td>
                        <td>{{ config.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if not config.is_active %}
                                <form method="post" action="/web/activate-backend/{{ config.id }}" style="display: inline;">
                                    <button type="submit" class="btn-small" style="background: #28a745; color: white;">激活</button>
                                </form>
                            {% endif %}
                            {% if not config.is_default %}
                                <form method="post" action="/web/delete-backend/{{ config.id }}" style="display: inline; margin-left: 5px;">
                                    <button type="submit" class="btn-small btn-danger" 
                                            onclick="return confirm('确定要删除这个后端配置吗？')">删除</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not backend_configs %}
            <p style="text-align: center; color: #666; padding: 20px;">暂无后端配置</p>
            {% endif %}
        </div>
    </div>

    <!-- 使用趋势图标签页 -->
    <div id="charts" class="tab-content chart-container">
        <div class="charts-grid">
            <div class="chart-section">
                <h3>每日请求数趋势</h3>
                <div class="chart-wrapper">
                    <canvas id="requestsChart"></canvas>
                </div>
            </div>
            <div class="chart-section">
                <h3>每日Token使用量趋势</h3>
                <div class="chart-wrapper">
                    <canvas id="tokensChart"></canvas>
                </div>
            </div>
            <div class="chart-section">
                <h3>每日成本趋势</h3>
                <div class="chart-wrapper">
                    <canvas id="costsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 密钥详情模态框 -->
    <div id="keyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: relative; top: 10%; margin: 0 auto; width: 90%; max-width: 1000px; background: white; padding: 20px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">密钥详情</h3>
                <button onclick="closeKeyModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <!-- 模态框标签页 -->
            <div style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button class="modal-tab active" onclick="switchModalTab('stats')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #007bff;">统计信息</button>
                <button class="modal-tab" onclick="switchModalTab('chart')" style="padding: 10px 20px; border: none; background: none; cursor: pointer; color: #666;">使用趋势</button>
            </div>
            
            <div id="modalStats" class="modal-content">
                <p>正在加载...</p>
            </div>
            
            <div id="modalChart" class="modal-content" style="display: none;">
                <div style="height: 400px;">
                    <canvas id="keyUsageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentKeyId = null;
        let keyUsageChart = null;
        let requestsChart = null;
        let tokensChart = null; 
        let costsChart = null;
        
        // 标签页切换
        function switchTab(tabName) {
            // 更新标签按钮状态
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // 显示对应内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            document.getElementById(tabName).classList.add('active');
            document.getElementById(tabName).style.display = 'block';
            
            // 如果切换到图表标签页，加载图表
            if (tabName === 'charts') {
                loadCharts();
            }
        }
        
        // 模态框标签页切换
        function switchModalTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.borderBottom = 'none';
                tab.style.color = '#666';
            });
            document.querySelector(`[onclick="switchModalTab('${tabName}')"]`).classList.add('active');
            document.querySelector(`[onclick="switchModalTab('${tabName}')"]`).style.borderBottom = '2px solid #007bff';
            document.querySelector(`[onclick="switchModalTab('${tabName}')"]`).style.color = '#007bff';
            
            document.querySelectorAll('.modal-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (tabName === 'stats') {
                document.getElementById('modalStats').style.display = 'block';
            } else if (tabName === 'chart') {
                document.getElementById('modalChart').style.display = 'block';
                if (currentKeyId) {
                    loadKeyChart(currentKeyId);
                }
            }
        }
        
        function showKeyDetails(keyId, keyName) {
            currentKeyId = keyId;
            document.getElementById('modalTitle').textContent = `${keyName} - 使用详情`;
            document.getElementById('keyModal').style.display = 'block';
            
            // 重置到统计信息标签页
            switchModalTab('stats');
            
            // 加载详细统计
            fetch(`/usage/stats/${keyId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modalStats').innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-number">${data.total_requests.toLocaleString()}</div>
                                <div class="stat-label">总请求数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.total_tokens.toLocaleString()}</div>
                                <div class="stat-label">总Token使用量</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">$${data.total_cost.toFixed(4)}</div>
                                <div class="stat-label">总成本</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.avg_processing_time.toFixed(2)}s</div>
                                <div class="stat-label">平均处理时间</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.avg_output_tps ? data.avg_output_tps.toFixed(1) : '0.0'} TPS</div>
                                <div class="stat-label">平均输出速度</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="stat-card">
                                <div class="stat-number">${data.requests_today.toLocaleString()}</div>
                                <div class="stat-label">今日请求数</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.tokens_today.toLocaleString()}</div>
                                <div class="stat-label">今日Token使用量</div>
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    document.getElementById('modalStats').innerHTML = `<p style="color: #dc3545;">加载失败: ${error.message}</p>`;
                });
        }
        
        // 加载主页面图表
        function loadCharts() {
            if (requestsChart || tokensChart || costsChart) return; // 避免重复加载
            
            // 获取所有API密钥的汇总图表数据
            fetch('/usage/summary')
                .then(response => response.json())
                .then(data => {
                    // 创建模拟的30天数据（实际应该从API获取）
                    const dates = [];
                    const requests = [];
                    const tokens = [];
                    const costs = [];
                    
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        dates.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                        
                        // 模拟数据，实际应该从/usage/chart接口获取
                        requests.push(Math.floor(Math.random() * 100 + 50));
                        tokens.push(Math.floor(Math.random() * 50000 + 10000));
                        costs.push(Math.random() * 5 + 1);
                    }
                    
                    // 请求数趋势图
                    const requestsCtx = document.getElementById('requestsChart').getContext('2d');
                    requestsChart = new Chart(requestsCtx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: '请求数',
                                data: requests,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // Token使用量趋势图
                    const tokensCtx = document.getElementById('tokensChart').getContext('2d');
                    tokensChart = new Chart(tokensCtx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Token使用量',
                                data: tokens,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // 成本趋势图
                    const costsCtx = document.getElementById('costsChart').getContext('2d');
                    costsChart = new Chart(costsCtx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: '成本 ($)',
                                data: costs,
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        }
        
        // 加载单个密钥的图表
        function loadKeyChart(keyId) {
            if (keyUsageChart) {
                keyUsageChart.destroy();
            }
            
            fetch(`/usage/chart/${keyId}?days=30`)
                .then(response => response.json())
                .then(result => {
                    const data = result.data;
                    const dates = data.map(d => new Date(d.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                    const requests = data.map(d => d.total_requests);
                    const tokens = data.map(d => d.total_tokens);
                    const costs = data.map(d => d.total_cost);
                    
                    const ctx = document.getElementById('keyUsageChart').getContext('2d');
                    keyUsageChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                                {
                                    label: '请求数',
                                    data: requests,
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Token使用量',
                                    data: tokens,
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    yAxisID: 'y1'
                                },
                                {
                                    label: '成本 ($)',
                                    data: costs,
                                    borderColor: '#ffc107',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    yAxisID: 'y2'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: '日期'
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: '请求数'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Token使用量'
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                },
                                y2: {
                                    type: 'linear',
                                    display: false,
                                    position: 'right',
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('加载图表失败:', error);
                });
        }
        
        function closeKeyModal() {
            document.getElementById('keyModal').style.display = 'none';
            if (keyUsageChart) {
                keyUsageChart.destroy();
                keyUsageChart = null;
            }
        }
        
        // API密钥编辑功能
        function editKey(keyId) {
            // 隐藏显示元素，显示编辑元素
            document.getElementById(`rate-display-${keyId}`).style.display = 'none';
            document.getElementById(`quota-display-${keyId}`).style.display = 'none';
            document.getElementById(`actions-display-${keyId}`).style.display = 'none';
            
            document.getElementById(`rate-edit-${keyId}`).style.display = 'inline';
            document.getElementById(`quota-edit-${keyId}`).style.display = 'inline';
            document.getElementById(`actions-edit-${keyId}`).style.display = 'block';
        }
        
        function cancelEdit(keyId) {
            // 恢复原始值
            const rateInput = document.getElementById(`rate-edit-${keyId}`);
            const quotaInput = document.getElementById(`quota-edit-${keyId}`);
            
            // 重置为原始值（从display元素获取）
            const rateDisplay = document.getElementById(`rate-display-${keyId}`).textContent;
            const quotaDisplay = document.getElementById(`quota-display-${keyId}`).textContent;
            
            rateInput.value = parseInt(rateDisplay.replace('/小时', ''));
            quotaInput.value = parseInt(quotaDisplay.replace(/,/g, ''));
            
            // 隐藏编辑元素，显示显示元素
            document.getElementById(`rate-display-${keyId}`).style.display = 'inline';
            document.getElementById(`quota-display-${keyId}`).style.display = 'inline';
            document.getElementById(`actions-display-${keyId}`).style.display = 'block';
            
            document.getElementById(`rate-edit-${keyId}`).style.display = 'none';
            document.getElementById(`quota-edit-${keyId}`).style.display = 'none';
            document.getElementById(`actions-edit-${keyId}`).style.display = 'none';
        }
        
        function saveKey(keyId) {
            const rateLimit = document.getElementById(`rate-edit-${keyId}`).value;
            const quotaLimit = document.getElementById(`quota-edit-${keyId}`).value;
            
            if (!rateLimit || !quotaLimit || rateLimit < 0 || quotaLimit < 0) {
                alert('请输入有效的限制值');
                return;
            }
            
            // 发送更新请求
            fetch(`/admin/api-keys/${keyId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // 使用cookie认证
                body: JSON.stringify({
                    rate_limit: parseInt(rateLimit),
                    quota_limit: parseInt(quotaLimit)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    // 更新显示
                    document.getElementById(`rate-display-${keyId}`).textContent = `${rateLimit}/小时`;
                    document.getElementById(`quota-display-${keyId}`).textContent = parseInt(quotaLimit).toLocaleString();
                    
                    // 切换回显示模式
                    cancelEdit(keyId);
                    
                    alert('更新成功');
                } else {
                    alert('更新失败: ' + (data.detail || '未知错误'));
                }
            })
            .catch(error => {
                console.error('更新失败:', error);
                alert('更新失败: ' + error.message);
            });
        }
        
        // 点击模态框外部关闭
        document.getElementById('keyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeKeyModal();
            }
        });
    </script>
</body>
</html>